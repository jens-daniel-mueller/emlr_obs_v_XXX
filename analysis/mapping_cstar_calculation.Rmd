---
title: "Mapping cstar"
author: "Jens Daniel MÃ¼ller"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  workflowr::wflow_html:
    number_sections: true
    toc_depth: 3
    toc_float:
      collapsed: false
editor_options:
  chunk_output_type: console
---

```{r parent, child = "/nfs/kryo/work/jenmueller/emlr_cant/utilities/setup.Rmd"}
# this chunk runs the code stored in setup.Rmd
# if required, please refer to instructions given here:
# https://jdblischak.github.io/workflowr/articles/wflow-07-common-code.html
```

```{r read_params_local, include = FALSE}
params_local <-
  read_rds(here::here("data/auxillary",
                       "params_local.rds"))

```

```{r define_paths, include = FALSE}

# only path_observations needs to be changed to model
path_observations <-
  paste(path_root, "/observations/", sep = "")

path_preprocessing    <-
  paste(path_observations, "preprocessing/", sep = "")

path_version_data     <-
  paste(path_observations,
        params_local$Version_ID,
        "/data/",
        sep = "")

path_version_figures  <-
  paste(path_observations,
        params_local$Version_ID,
        "/figures/",
        sep = "")
```

# Predictor fields

Currently, we use combined predictor fields:

- WOA18: S, T, and derived variables
- GLODAP16: Oxygen, PO4, NO3, Silicate, and derived variables

```{r read_predictor_file}

predictors <-
  read_csv(paste(path_version_data,
                 "W18_st_G16_opsn.csv",
                 sep = ""))

```


# Load MLR models

```{r load_eMLR_models}

lm_all_wide_cstar <-
  read_csv(paste(path_version_data,
                 "lm_all_cstar.csv",
                 sep = ""))

```

# Merge MLRs + climatologies

```{r merge_model_coeff_predictor_climatology}

lm_all_wide_cstar <- lm_all_wide_cstar %>%
  mutate(model = str_remove(model, "cstar ~ "))
         
cstar <- full_join(predictors, lm_all_wide_cstar)

rm(predictors, lm_all_wide_cstar)


```


# Map cstar

## Apply MLRs to predictor

```{r calculate_cstar}

cstar <- b_cstar_model(cstar)

cstar <- cstar %>% 
  select(lon, lat, depth, era, basin, basin_AIP, cstar, gamma)

```

```{r cstar_average}

cstar_average <- m_cstar_model_average(cstar)

rm(cstar)

cstar_average <- m_cut_gamma(cstar_average, "gamma")

```

## Mean cstar sections

For each basin and era combination, the zonal mean cstar is calculated. Likewise, sd is calculated for the averaging of the mean basin fields.

```{r Calculate_cstar_mean_sections}

cstar_average_zonal <- m_cstar_zonal_mean(cstar_average)

cstar_average_zonal <- m_cut_gamma(cstar_average_zonal, "gamma_mean")

```

# Write csv

```{r write_cstar_files}

cstar_average %>%
  write_csv(paste(path_version_data,
                  "cstar_3d.csv",
                  sep = ""))

cstar_average_zonal %>%
  write_csv(paste(path_version_data,
                  "cstar_zonal.csv",
                  sep = ""))

```
