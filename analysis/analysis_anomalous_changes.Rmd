---
title: "Analysis of cant estimates"
author: "Jens Daniel MÃ¼ller"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  workflowr::wflow_html:
    number_sections: true
    toc_depth: 3
    toc_float:
      collapsed: false
editor_options:
  chunk_output_type: console
params:
  Version_ID: "v_XXX"
---

```{r parent, child = "/nfs/kryo/work/jenmueller/emlr_cant/utilities/setup.Rmd"}
# this chunk runs the code stored in setup.Rmd
# if required, please refer to instructions given here:
# https://jdblischak.github.io/workflowr/articles/wflow-07-common-code.html
```

```{r read_params_local, include = FALSE}

if (params$Version_ID == "v_XXX") {
  params_local <-
    read_rds(here::here("data/auxillary", "params_local.rds"))
  
} else {
  params_local <-
    read_rds(
      file = paste(path_root, "observations",
                   params$Version_ID,
                   "data/params_local.rds",
                   sep = "/")
    )
}

```

```{r define_paths, include = FALSE}

# only path_observations needs to be changed to model
path_observations <-
  paste(path_root, "/observations/", sep = "")

path_preprocessing    <-
  paste(path_observations, "preprocessing/", sep = "")

path_preprocessing_model    <-
  paste(path_root, "/model/preprocessing/", sep = "")

path_version_data     <-
  paste(path_observations,
        params_local$Version_ID,
        "/data/",
        sep = "")

path_version_figures  <-
  paste(path_observations,
        params_local$Version_ID,
        "/figures/",
        sep = "")
```

```{r load_libraries_specific, include = FALSE}

library(purrr)

```


```{r select_basin_mask, include=FALSE}

basinmask <- basinmask %>% 
  filter(MLR_basins == params_local$MLR_basins) %>% 
  select(-c(MLR_basins, basin))

```


# Version ID

The results displayed on this site correspond to the Version_ID: `r params$Version_ID`

# Data sources

Required are: 

- Cant from Sabine 2004 (S04)
- Cant from Gruber 2019 (G19)
- annual mean atmospheric pCO~2~ 

- Mean eMLR-Cant per grid cell (lat, lon, depth)


```{r read_cant_files}

cant_3d_tref <- read_csv(paste(path_version_data,
                               "cant_3d_tref.csv",
                               sep = ""))

cant_3d <-
  read_csv(paste(path_version_data,
                 "cant_3d.csv",
                 sep = ""))

co2_atm <-
  read_csv(paste(path_preprocessing,
                 "co2_atm.csv",
                 sep = ""))

tref <-
  read_csv(paste(path_version_data,
                 "tref.csv",
                 sep = ""))

```


```{r zonal_mean_section_plot_function}

m_zonal_mean_section <- function(df) {

  df_zonal_mean_section <- df %>%
    fselect(-lon) %>% 
    fgroup_by(lat, depth, basin_AIP) %>% {
      add_vars(fgroup_vars(.,"unique"),
               fmean(., keep.group_vars = FALSE) %>% add_stub(pre = FALSE, "_mean"),
               fsd(., keep.group_vars = FALSE) %>% add_stub(pre = FALSE, "_sd"))
    }
  
  return(df_zonal_mean_section)

}

```

# Calculate ss Cant

```{r estimate_ss_cant}

# calculate delta cant as the difference between total cant at tref
# this includes the G19 anomaly
cant_3d_tref_wide <- cant_3d_tref %>%
  pivot_wider(names_from = era,
              values_from = "cant_pos") %>% 
  mutate(delta_cant_pos_G19 = `2010-2019` - `2000-2009`) %>% 
  drop_na()

# join with basinmask
cant_3d_tref_wide <- inner_join(basinmask, cant_3d_tref_wide)

# extract atm pCO2 at reference year
co2_atm_tref <- right_join(co2_atm, tref %>% rename(year = median_year)) %>% 
  select(-year) %>% 
  rename(pCO2_tref = pCO2)

# atm pCO2 at tref 1,2,3
pCO2_to <- params_local$preind_atm_pCO2
pCO2_t1 <- co2_atm_tref$pCO2_tref[1]
pCO2_t2 <- co2_atm_tref$pCO2_tref[2]

# ratio of atm pCO2 changes between eras
delta_pCO2_ratio <- 
  (pCO2_t2 - pCO2_t1) /
  (pCO2_t1 - pCO2_to)

rm(pCO2_to)
rm(pCO2_t1)
rm(pCO2_t2)

# alpha for ss projection
alpha = delta_pCO2_ratio * 0.94 * 0.94

# calculate cstar for reference year
cant_3d_tref_wide <- cant_3d_tref_wide %>%
  rename(cant_pos_t1 = `2010-2019`,
         cant_pos_t2 = `2000-2009`) %>%
  mutate(delta_cant_pos_ss = alpha * cant_pos_t1)


```

# Zonal mean sections

## delta Cant

### G19 and ss projections

```{r zonal_section_plots_cant_pos}

# calculate zonal mean section
cant_tref_section <- cant_3d_tref_wide %>%
  group_by(data_source) %>%
  nest() %>%
  mutate(section = map(.x = data, ~m_zonal_mean_section(.x))) %>%
  select(-data) %>%
  unnest(section)


cant_tref_section_long <- cant_tref_section %>%
  pivot_longer(
    cols = c(delta_cant_pos_G19_mean, delta_cant_pos_ss_mean),
    values_to = "delta_cant",
    names_to = "estimate",
    names_prefix = "delta_cant_pos_"
  )

cant_tref_section_long %>% 
  group_by(basin_AIP, data_source, estimate) %>%
  group_split() %>% 
  map( ~ p_section_zonal(
    df = .x,
    var = "delta_cant",
    plot_slabs = "n",
    subtitle_text = paste("Basin:", .x$basin_AIP, "| Data:", .x$data_source, "| Estimate:", .x$estimate)
  ))

```

### ss vs true

```{r zonal_section_plots_delta_cant_pos}

# calculate section of anomalous changes
cant_tref_section <- cant_tref_section %>%
  mutate(delta_cant_pos_anomalous = delta_cant_pos_G19_mean - delta_cant_pos_ss_mean)

cant_tref_section %>%
  group_by(basin_AIP, data_source) %>%
  group_split() %>%
  map( ~ p_section_zonal(
    df = .x,
    col = "divergent",
    var = "delta_cant_pos_anomalous",
    plot_slabs = "n",
    breaks = params_global$breaks_cant_offset,
    subtitle_text = paste(.x$basin_AIP, .x$data_source)
  ))


```

### ss vs eMLR

```{r anomalous_change_emlr}

cant_3d_anom <- inner_join(cant_3d, cant_3d_tref_wide)

cant_3d_anom <- cant_3d_anom %>% 
  mutate(delta_cant_pos_emlr_ss = cant_pos - delta_cant_pos_ss)

cant_anom_section <- cant_3d_anom %>%
  select(lon, lat, depth, basin_AIP, data_source, delta_cant_pos_emlr_ss) %>% 
  group_by(data_source) %>%
  nest() %>%
  mutate(section = map(.x = data, ~m_zonal_mean_section(.x))) %>%
  select(-data) %>%
  unnest(section)

cant_anom_section %>%
  group_by(basin_AIP, data_source) %>%
  group_split() %>%
  map( ~ p_section_zonal(
    df = .x,
    col = "divergent",
    var = "delta_cant_pos_emlr_ss_mean",
    plot_slabs = "n",
    breaks = params_global$breaks_cant_offset,
    subtitle_text = paste(.x$basin_AIP, .x$data_source)
  ))



```

