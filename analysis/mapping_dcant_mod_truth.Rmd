---
title: "Mapping cant"
author: "Jens Daniel MÃ¼ller"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  workflowr::wflow_html:
    number_sections: true
    toc_depth: 3
    toc_float:
      collapsed: false
editor_options:
  chunk_output_type: console
params:
  Version_ID: "v_XXX"
---

```{r parent, child = "/nfs/kryo/work/jenmueller/emlr_cant/utilities/setup_obs.Rmd"}
# this chunk runs the code stored in setup.Rmd
# if required, please refer to instructions given here:
# https://jdblischak.github.io/workflowr/articles/wflow-07-common-code.html
```

```{r read_params_local, include = FALSE}

if (params$Version_ID == "v_XXX") {
  params_local <-
    read_rds(here::here("data/auxillary", "params_local.rds"))
  
} else {
  params_local <-
    read_rds(
      file = paste(path_root, "observations",
                   params$Version_ID,
                   "data/params_local.rds",
                   sep = "/")
    )
}


```

```{r define_paths, include = FALSE}

# only path_observations needs to be changed to model
path_observations <-
  paste(path_root, "/observations/", sep = "")

path_preprocessing    <-
  paste(path_observations, "preprocessing/", sep = "")

path_model_preprocessing    <-
  paste(path_root, "/model/preprocessing/", sep = "")

path_version_data     <-
  paste(path_observations,
        params_local$Version_ID,
        "/data/",
        sep = "")

path_version_figures  <-
  paste(path_observations,
        params_local$Version_ID,
        "/figures/",
        sep = "")
```

```{r load_libraries_specific, include=FALSE}
library(marelac)
```


# Version ID

The results displayed on this site correspond to the Version_ID: `r params$Version_ID`

# Required data

- tcant 3D fields at tref1 and tref2 for variable and constant climate model runs


```{r read_model_tcant_files_vc}

tref  <-
  read_csv(paste(path_version_data,
                 "tref.csv",
                 sep = ""))

tcant_tref_1 <-
  read_csv(
    paste(
      path_model_preprocessing,
      "cant_annual_field_AD",
      "/cant_",
      unique(tref$median_year[1]),
      ".csv",
      sep = ""
    )
  )

tcant_tref_1 <- tcant_tref_1 %>%
  rename(tcant_tref_1 = cant_total) %>%
  select(-year)

tcant_tref_2 <-
  read_csv(
    paste(
      path_model_preprocessing,
      "cant_annual_field_AD",
      "/cant_",
      unique(tref$median_year[2]),
      ".csv",
      sep = ""
    )
  )

tcant_tref_2 <- tcant_tref_2 %>%
  rename(tcant_tref_2 = cant_total) %>%
  select(-year)

```

```{r read_model_tcant_files_cc}

tcant_cc_tref_1 <-
  read_csv(
    paste(
      path_model_preprocessing,
      "cant_annual_field_CB",
      "/cant_",
      unique(tref$median_year[1]),
      ".csv",
      sep = ""
    )
  )

tcant_cc_tref_1 <- tcant_cc_tref_1 %>%
  rename(tcant_tref_1 = cant_total) %>%
  select(-year)

tcant_cc_tref_2 <-
  read_csv(
    paste(
      path_model_preprocessing,
      "cant_annual_field_CB",
      "/cant_",
      unique(tref$median_year[2]),
      ".csv",
      sep = ""
    )
  )

tcant_cc_tref_2 <- tcant_cc_tref_2 %>%
  rename(tcant_tref_2 = cant_total) %>%
  select(-year)

```


```{r read_model_cstar_files_vc}

cstar_tref_1 <-
  read_csv(
    paste(
      path_model_preprocessing,
      "cstar_annual_field_A",
      "/cstar_A_",
      unique(tref$median_year[1]),
      ".csv",
      sep = ""
    )
  )

cstar_tref_1 <- cstar_tref_1 %>%
  select(lon, lat, depth, cstar_no3, cstar_po4) %>% 
  pivot_longer(cstar_no3:cstar_po4,
               names_to = "data_source",
               names_prefix = "cstar_",
               values_to = "cstar_tref_1")

cstar_tref_2 <-
  read_csv(
    paste(
      path_model_preprocessing,
      "cstar_annual_field_A",
      "/cstar_A_",
      unique(tref$median_year[2]),
      ".csv",
      sep = ""
    )
  )

cstar_tref_2 <- cstar_tref_2 %>%
  select(lon, lat, depth, cstar_no3, cstar_po4) %>% 
  pivot_longer(cstar_no3:cstar_po4,
               names_to = "data_source",
               names_prefix = "cstar_",
               values_to = "cstar_tref_2")

```


```{r load_model_gamma_climatology}

climatology <-
  read_csv(paste0(path_model_preprocessing,
                  "climatology_runA_2007.csv"))

climatology <- climatology %>%
  select(lon, lat, depth, gamma)

```

# dcant calculation

```{r calc_model_cant_between_tref_vc}

dcant_3d <- left_join(tcant_tref_1, tcant_tref_2) %>%
  mutate(dcant = tcant_tref_2 - tcant_tref_1)

rm(tcant_tref_1, tcant_tref_2)

dcant_3d <- dcant_3d %>%
  mutate(dcant_pos = if_else(dcant <= 0, 0, dcant))

dcant_3d <- full_join(dcant_3d, climatology)

dcant_3d <- dcant_3d %>%
  mutate(
    method = "surface",
    method = if_else(
      depth >= params_local$depth_min | gamma >= params_local$gamma_min,
      "eMLR",
      method
    )
  )

dcant_3d <- m_cut_gamma(dcant_3d, "gamma")

dcant_3d_vc <- dcant_3d %>% 
  mutate(data_source = "mod_truth") %>% 
  select(lon, lat, depth, basin_AIP, data_source, method,
            tcant_tref_1, dcant, dcant_pos,
            gamma, gamma_slab)

```

```{r calc_model_cant_between_tref_cc}

dcant_3d <- left_join(tcant_cc_tref_1, tcant_cc_tref_2) %>%
  mutate(dcant = tcant_tref_2 - tcant_tref_1)

rm(tcant_cc_tref_1, tcant_cc_tref_2)

dcant_3d <- dcant_3d %>%
  mutate(dcant_pos = if_else(dcant <= 0, 0, dcant))

dcant_3d <- full_join(dcant_3d, climatology)

dcant_3d <- dcant_3d %>%
  mutate(
    method = "surface",
    method = if_else(
      depth >= params_local$depth_min | gamma >= params_local$gamma_min,
      "eMLR",
      method
    )
  )

dcant_3d <- m_cut_gamma(dcant_3d, "gamma")

dcant_3d_cc <- dcant_3d %>% 
  mutate(data_source = "mod_truth_cc") %>% 
  select(lon, lat, depth, basin_AIP, data_source, method,
            tcant_tref_1, dcant, dcant_pos,
            gamma, gamma_slab)

rm(dcant_3d)

```

```{r join_climate_runs}

dcant_3d <- bind_rows(
  dcant_3d_cc,
  dcant_3d_vc
)

rm(
  dcant_3d_cc,
  dcant_3d_vc
)


```

```{r test_surface_data}

surface_data <- nrow(dcant_3d %>% filter(method == "surface")) > 0

```


```{r calc_model_dcant_between_tref_vc_cstar}

dcant_3d_cstar <- left_join(cstar_tref_1, cstar_tref_2) %>%
  mutate(dcant = cstar_tref_2 - cstar_tref_1)

rm(cstar_tref_1, cstar_tref_2)

dcant_3d_cstar <- dcant_3d_cstar %>%
  mutate(dcant_pos = if_else(dcant <= 0, 0, dcant))

dcant_3d_cstar <- full_join(dcant_3d_cstar, climatology)

dcant_3d_cstar <- dcant_3d_cstar %>%
  mutate(
    method = "surface",
    method = if_else(
      depth >= params_local$depth_min | gamma >= params_local$gamma_min,
      "eMLR",
      method
    )
  )

dcant_3d_cstar <- m_cut_gamma(dcant_3d_cstar, "gamma")

dcant_3d_cstar <- inner_join(
  dcant_3d_cstar,
  basinmask %>%
    filter(MLR_basins == params_local$MLR_basins) %>%
    select(-MLR_basins)
) 

dcant_3d_cstar <- dcant_3d_cstar %>% 
  # mutate(data_source = "mod_truth_cstar") %>% 
  select(lon, lat, depth, basin_AIP, data_source, data_source, method,
            cstar_tref_1, cstar_tref_2, dcant, dcant_pos,
            gamma, gamma_slab)

```


# Maps

```{r cant_deep_climatology_map, fig.asp=0.6}

dcant_3d %>%
  group_split(data_source) %>%
  # head(1) %>%
  map(~ p_map_climatology(
    df = .x,
    var = "dcant",
    subtitle_text = paste("Climate: ", .x$data_source)
  ))

```


```{r cant_deep_climatology_map_cstar, fig.asp=0.6}

dcant_3d_cstar %>%
  group_split(data_source) %>%
  # head(1) %>%
  map(~ p_map_climatology(
    df = .x,
    var = "dcant",
    subtitle_text = paste("data_source: ", .x$data_source)
  ))

```


```{r cant_deep_climatology_sections, fig.asp=1}

dcant_3d %>%
  group_split(data_source) %>%
  # head(1) %>%
  map(~ p_section_climatology_regular(
    df = .x,
    var = "dcant",
    subtitle_text = paste("Climate: ", .x$data_source)
  ))

```

```{r cant_deep_climatology_sections_cstar, fig.asp=1}

dcant_3d_cstar %>%
  group_split(data_source) %>%
  # head(1) %>%
  map(~ p_section_climatology_regular(
    df = .x,
    var = "dcant",
    subtitle_text = paste("data_source: ", .x$data_source)
  ))

```

# Averaging and integration

## Zonal sections

```{r calc_cant_zonal_mean_sections}

dcant_zonal <- dcant_3d %>%
  group_by(data_source) %>%
  nest() %>%
  mutate(zonal = map(.x = data, ~m_zonal_mean_sd(.x))) %>%
  select(-data) %>%
  unnest(zonal)

dcant_zonal <- m_cut_gamma(dcant_zonal, "gamma_mean")

dcant_zonal_method <- dcant_3d %>%
  group_by(data_source, method) %>%
  nest() %>%
  mutate(zonal = map(.x = data, ~m_zonal_mean_sd(.x))) %>%
  select(-data) %>%
  unnest(zonal)

dcant_zonal_method <- m_cut_gamma(dcant_zonal_method,
                                   "gamma_mean")

dcant_zonal <- dcant_zonal %>% 
  rename(dcant = dcant_mean,
         dcant_pos = dcant_pos_mean)

dcant_zonal_method <- dcant_zonal_method %>% 
  rename(dcant = dcant_mean,
         dcant_pos = dcant_pos_mean)

```

```{r calc_dcant_zonal_mean_sections_cstar}

dcant_zonal_cstar <- dcant_3d_cstar %>%
  group_by(data_source) %>%
  nest() %>%
  mutate(zonal = map(.x = data, ~m_zonal_mean_sd(.x))) %>%
  select(-data) %>%
  unnest(zonal)

dcant_zonal_cstar <- m_cut_gamma(dcant_zonal_cstar, "gamma_mean")

dcant_zonal_method_cstar <- dcant_3d_cstar %>%
  group_by(data_source, method) %>%
  nest() %>%
  mutate(zonal = map(.x = data, ~m_zonal_mean_sd(.x))) %>%
  select(-data) %>%
  unnest(zonal)

dcant_zonal_method_cstar <- m_cut_gamma(dcant_zonal_method_cstar,
                                   "gamma_mean")

dcant_zonal_cstar <- dcant_zonal_cstar %>% 
  rename(dcant = dcant_mean,
         dcant_pos = dcant_pos_mean)

dcant_zonal_method_cstar <- dcant_zonal_method_cstar %>% 
  rename(dcant = dcant_mean,
         dcant_pos = dcant_pos_mean)

```

## Inventories

To calculate dcant column inventories, we:  

1. Convert Cant concentrations to volumetric units
2. Multiply layer thickness with volumetric Cant concentration to get a layer inventory
3. For each horizontal grid cell and era, sum cant layer inventories for different inventory depths (`r params_global$inventory_depths` m)

Step 2 is performed separately for all Cant and positive Cant values only.

### Full water column

```{r calc_dcant_inventories, fig.asp=1}

dcant_inv <- dcant_3d %>%
  group_by(data_source) %>%
  nest() %>%
  mutate(inv = map(.x = data, ~m_dcant_inv(.x))) %>%
  select(-data) %>%
  unnest(inv)

p_map_cant_inv(df = dcant_inv,
               var = "dcant",
               subtitle_text = "for predefined integration depths") +
  facet_grid(inv_depth ~ data_source)

if (surface_data == FALSE){
  dcant_inv <- dcant_inv %>% 
    mutate(method = "total")
}

```

```{r calc_dcant_inventories_cstar, fig.asp=1}

dcant_inv_cstar <- dcant_3d_cstar %>%
  group_by(data_source) %>%
  nest() %>%
  mutate(inv = map(.x = data, ~m_dcant_inv(.x))) %>%
  select(-data) %>%
  unnest(inv)

p_map_cant_inv(df = dcant_inv_cstar,
               var = "dcant",
               subtitle_text = "for predefined integration depths") +
  facet_grid(inv_depth ~ data_source)

if (surface_data == FALSE){
  dcant_inv <- dcant_inv %>% 
    mutate(method = "total")
}

```


### Surface layer

```{r cant_inventories_surface, eval=surface_data}

dcant_inv_surface <- dcant_3d %>%
  filter(method == "surface") %>% 
  group_by(data_source) %>%
  nest() %>%
  mutate(inv = map(.x = data, ~m_dcant_inv(.x))) %>%
  select(-data) %>%
  unnest(inv)

p_map_cant_inv(
  df = dcant_inv_surface %>%
    filter(inv_depth < 1000),
  var = "dcant_pos",
  subtitle_text = "for predefined integration depths",
  breaks = c(-Inf, seq(0, 4, 0.5), Inf)
) +
  facet_grid(inv_depth ~ data_source)


```

```{r cant_inventories_surface_cstar, eval=surface_data}

dcant_inv_surface_cstar <- dcant_3d_cstar %>%
  filter(method == "surface") %>% 
  group_by(data_source) %>%
  nest() %>%
  mutate(inv = map(.x = data, ~m_dcant_inv(.x))) %>%
  select(-data) %>%
  unnest(inv)

p_map_cant_inv(
  df = dcant_inv_surface_cstar %>%
    filter(inv_depth < 1000),
  var = "dcant_pos",
  subtitle_text = "for predefined integration depths",
  breaks = c(-Inf, seq(0, 4, 0.5), Inf)
) +
  facet_grid(inv_depth ~ data_source)


```

### eMLR only

```{r combine_dcant_inventories, eval=surface_data}

dcant_inv <- full_join(
  dcant_inv %>% rename(dcant_total = dcant,
                       dcant_pos_total = dcant_pos),
  dcant_inv_surface %>% rename(dcant_surface = dcant,
                               dcant_pos_surface = dcant_pos)
)

dcant_inv <- dcant_inv %>%
  mutate(dcant_eMLR = dcant_total -
           replace(dcant_surface, is.na(dcant_surface), 0),
         dcant_pos_eMLR = dcant_pos_total -
           replace(dcant_pos_surface, is.na(dcant_pos_surface), 0))

dcant_inv_all <- dcant_inv %>% 
  select(-starts_with("dcant_pos")) %>% 
  pivot_longer(starts_with("dcant_"),
               names_to = "method",
               names_prefix = "dcant_",
               values_to = "dcant")

dcant_inv_pos <- dcant_inv %>% 
  select(data_source, lon, lat, basin_AIP, inv_depth,
         starts_with("dcant_pos_")) %>% 
  pivot_longer(starts_with("dcant_pos_"),
               names_to = "method",
               names_prefix = "dcant_pos_",
               values_to = "dcant_pos")

dcant_inv <- full_join(
  dcant_inv_all,
  dcant_inv_pos
)

rm(dcant_inv_all, dcant_inv_pos, dcant_inv_surface)

dcant_inv %>%
  group_by(inv_depth) %>%
  group_split() %>% 
  # tail(1) %>%
  map(
    ~ p_map_cant_inv(df = .x,
                     var = "dcant",
                     subtitle_text = paste("Integration depth",
                                           unique(.x$inv_depth))) +
      facet_grid(method ~ data_source)
  )

```


```{r combine_dcant_inventories_cstar, eval=surface_data}

dcant_inv_cstar <- full_join(
  dcant_inv_cstar %>% rename(dcant_total = dcant,
                       dcant_pos_total = dcant_pos),
  dcant_inv_surface_cstar %>% rename(dcant_surface = dcant,
                               dcant_pos_surface = dcant_pos)
)

dcant_inv_cstar <- dcant_inv_cstar %>%
  mutate(dcant_eMLR = dcant_total -
           replace(dcant_surface, is.na(dcant_surface), 0),
         dcant_pos_eMLR = dcant_pos_total -
           replace(dcant_pos_surface, is.na(dcant_pos_surface), 0))

dcant_inv_all_cstar <- dcant_inv_cstar %>% 
  select(-starts_with("dcant_pos")) %>% 
  pivot_longer(starts_with("dcant_"),
               names_to = "method",
               names_prefix = "dcant_",
               values_to = "dcant")

dcant_inv_pos_cstar <- dcant_inv_cstar %>% 
  select(data_source, lon, lat, basin_AIP, inv_depth,
         starts_with("dcant_pos_")) %>% 
  pivot_longer(starts_with("dcant_pos_"),
               names_to = "method",
               names_prefix = "dcant_pos_",
               values_to = "dcant_pos")

dcant_inv_cstar <- full_join(
  dcant_inv_all_cstar,
  dcant_inv_pos_cstar
)

rm(dcant_inv_all_cstar, dcant_inv_pos_cstar, dcant_inv_surface_cstar)

dcant_inv_cstar %>%
  group_by(inv_depth) %>%
  group_split() %>% 
  # tail(1) %>%
  map(
    ~ p_map_cant_inv(df = .x,
                     var = "dcant",
                     subtitle_text = paste("Integration depth",
                                           unique(.x$inv_depth))) +
      facet_grid(method ~ data_source)
  )

```


## Budgets

Global dcant budgets were estimated in units of Pg C. Please note that here we added dcant (all vs postitive only) values and do not apply additional corrections for areas not covered.

```{r budget_global}

dcant_budget_global <- m_dcant_budget(dcant_inv)

dcant_budget_global %>%
  filter(inv_depth == params_global$inventory_depth_standard,
         method == "total") %>%
  ggplot(aes(estimate, value)) +
  scale_fill_brewer(palette = "Dark2") +
  geom_col() +
  facet_grid(~data_source)

```

```{r budget_global_cstar}

dcant_budget_global_cstar <- m_dcant_budget(dcant_inv_cstar)

dcant_budget_global_cstar %>%
  filter(inv_depth == params_global$inventory_depth_standard,
         method == "total") %>%
  ggplot(aes(estimate, value)) +
  scale_fill_brewer(palette = "Dark2") +
  geom_col() +
  facet_grid(~data_source)

```

```{r budget_global_surface, eval=surface_data}

dcant_budget_global %>%
  filter(inv_depth == params_global$inventory_depth_standard,
         method %in% c("surface", "eMLR")) %>%
  ggplot(aes(estimate, value, fill=method)) +
  scale_fill_brewer(palette = "Dark2") +
  geom_col() +
  facet_grid(.~data_source)

```


```{r budget_global_surface_cstar, eval=surface_data}

dcant_budget_global_cstar %>%
  filter(inv_depth == params_global$inventory_depth_standard,
         method %in% c("surface", "eMLR")) %>%
  ggplot(aes(estimate, value, fill=method)) +
  scale_fill_brewer(palette = "Dark2") +
  geom_col() +
  facet_grid(.~data_source)

```


```{r budget_basin_AIP}

dcant_budget_basin_AIP <- dcant_inv %>% 
  group_by(basin_AIP) %>%
  nest() %>% 
  mutate(budget = map(.x = data, ~m_dcant_budget(.x))) %>% 
  select(-data) %>%
  unnest(budget)

```


```{r budget_basin_AIP_cstar}

dcant_budget_basin_AIP_cstar <- dcant_inv_cstar %>% 
  group_by(basin_AIP) %>%
  nest() %>% 
  mutate(budget = map(.x = data, ~m_dcant_budget(.x))) %>% 
  select(-data) %>%
  unnest(budget)

```

```{r budget_basin_AIP_fig, eval=surface_data}

dcant_budget_basin_AIP %>%
  filter(inv_depth == params_global$inventory_depth_standard,
         method %in% c("surface", "eMLR")) %>%
  ggplot(aes(basin_AIP, value, fill=method)) +
  scale_fill_brewer(palette = "Dark2") +
  geom_col() +
  facet_grid(estimate~data_source)

```

```{r budget_basin_AIP_fig_cstar, eval=surface_data}

dcant_budget_basin_AIP_cstar %>%
  filter(inv_depth == params_global$inventory_depth_standard,
         method %in% c("surface", "eMLR")) %>%
  ggplot(aes(basin_AIP, value, fill=method)) +
  scale_fill_brewer(palette = "Dark2") +
  geom_col() +
  facet_grid(estimate~data_source)

```


```{r budget_MLR_regions}

dcant_budget_basin_MLR <-
  full_join(dcant_inv, basinmask) %>%
  group_by(basin, MLR_basins) %>%
  nest() %>%
  mutate(budget = map(.x = data, ~ m_dcant_budget(.x))) %>%
  select(-data) %>%
  unnest(budget)

```

```{r budget_MLR_regions_cstar}

dcant_budget_basin_MLR_cstar <-
  full_join(dcant_inv_cstar, basinmask) %>%
  group_by(basin, MLR_basins) %>%
  nest() %>%
  mutate(budget = map(.x = data, ~ m_dcant_budget(.x))) %>%
  select(-data) %>%
  unnest(budget)

```


```{r budget_MLR_regions_fig, fig.asp=1, eval=surface_data}

dcant_budget_basin_MLR %>%
  filter(inv_depth == params_global$inventory_depth_standard,
         method %in% c("surface", "eMLR")) %>%
  group_by(MLR_basins) %>%
  group_split() %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(basin, value, fill = method)) +
      scale_fill_brewer(palette = "Dark2") +
      geom_col() +
      facet_grid(estimate ~ data_source) +
      labs(title = paste("MLR_basins:", unique(.x$MLR_basins)))
  )

```

```{r budget_MLR_regions_fig_cstar, fig.asp=1, eval=surface_data}

dcant_budget_basin_MLR_cstar %>%
  filter(inv_depth == params_global$inventory_depth_standard,
         method %in% c("surface", "eMLR")) %>%
  group_by(MLR_basins) %>%
  group_split() %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(basin, value, fill = method)) +
      scale_fill_brewer(palette = "Dark2") +
      geom_col() +
      facet_grid(estimate ~ data_source) +
      labs(title = paste("MLR_basins:", unique(.x$MLR_basins)))
  )

```


```{r budget_lat_grid, fig.asp=1}

dcant_budget_lat_grid <- 
  dcant_inv %>% 
  m_grid_horizontal_coarse() %>%
  group_by(lat_grid, basin_AIP) %>% 
  nest() %>%
  mutate(budget = map(.x = data, ~ m_dcant_budget(.x))) %>%
  select(-data) %>%
  unnest(budget)

```

```{r budget_lat_grid_cstar, fig.asp=1}

dcant_budget_lat_grid_cstar <- 
  dcant_inv_cstar %>% 
  m_grid_horizontal_coarse() %>%
  group_by(lat_grid, basin_AIP) %>% 
  nest() %>%
  mutate(budget = map(.x = data, ~ m_dcant_budget(.x))) %>%
  select(-data) %>%
  unnest(budget)

```

```{r budget_lat_grid_fig, fig.asp=1, eval=surface_data}

dcant_budget_lat_grid %>%
  filter(inv_depth == params_global$inventory_depth_standard,
         method %in% c("surface", "eMLR")) %>%
  group_by(basin_AIP) %>%
  group_split() %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(lat_grid, value, fill = method)) +
      scale_fill_brewer(palette = "Dark2") +
      geom_col() +
      coord_flip() +
      facet_grid(estimate ~ data_source) +
      labs(title = paste("MLR_basins:", unique(.x$basin_AIP)))
  )

```

```{r budget_lat_grid_fig_cstar, fig.asp=1, eval=surface_data}

dcant_budget_lat_grid_cstar %>%
  filter(inv_depth == params_global$inventory_depth_standard,
         method %in% c("surface", "eMLR")) %>%
  group_by(basin_AIP) %>%
  group_split() %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(lat_grid, value, fill = method)) +
      scale_fill_brewer(palette = "Dark2") +
      geom_col() +
      coord_flip() +
      facet_grid(estimate ~ data_source) +
      labs(title = paste("MLR_basins:", unique(.x$basin_AIP)))
  )

```




# Write csv

```{r write_cant_files}

dcant_3d <- dcant_3d %>%
  select(-c(tcant_tref_1))

dcant_3d %>%
  filter(data_source == "mod_truth") %>%
  write_csv(paste(path_version_data,
                  "dcant_3d_mod_truth.csv", sep = ""))

dcant_3d %>%
  filter(data_source == "mod_truth_cc") %>%
  write_csv(paste(path_version_data,
                  "dcant_3d_mod_truth_cc.csv", sep = ""))


dcant_zonal %>%
  filter(data_source == "mod_truth") %>%
  write_csv(paste(path_version_data,
                  "dcant_zonal_mod_truth.csv", sep = ""))

dcant_zonal_method %>%
  filter(data_source == "mod_truth") %>%
  write_csv(paste(path_version_data,
                  "dcant_zonal_mod_truth_method.csv", sep = ""))

dcant_zonal %>%
  filter(data_source == "mod_truth_cc") %>%
  write_csv(paste(path_version_data,
                  "dcant_zonal_mod_truth_cc.csv", sep = ""))

dcant_zonal_method %>%
  filter(data_source == "mod_truth_cc") %>%
  write_csv(paste(path_version_data,
                  "dcant_zonal_mod_truth_cc_method.csv", sep = ""))


dcant_inv %>%
  filter(data_source == "mod_truth",
         method == "total") %>%
  write_csv(paste(path_version_data,
                  "dcant_inv_mod_truth.csv", sep = ""))

dcant_inv %>%
  filter(data_source == "mod_truth_cc",
         method == "total") %>%
  write_csv(paste(path_version_data,
                  "dcant_inv_mod_truth_cc.csv", sep = ""))

dcant_inv %>%
  filter(data_source == "mod_truth",
         method != "total") %>%
  write_csv(paste(path_version_data,
                  "dcant_inv_mod_truth_method.csv", sep = ""))

dcant_inv %>%
  filter(data_source == "mod_truth_cc",
         method != "total") %>%
  write_csv(paste(path_version_data,
                  "dcant_inv_mod_truth_cc_method.csv", sep = ""))



dcant_budget_global %>%
  filter(data_source == "mod_truth") %>%
  write_csv(paste(path_version_data,
                  "dcant_budget_global_mod_truth.csv", sep = ""))

dcant_budget_global %>%
  filter(data_source == "mod_truth_cc") %>%
  write_csv(paste(path_version_data,
                  "dcant_budget_global_mod_truth_cc.csv", sep = ""))

dcant_budget_basin_AIP %>%
  filter(data_source == "mod_truth") %>%
  write_csv(paste(path_version_data,
                  "dcant_budget_basin_AIP_mod_truth.csv", sep = ""))

dcant_budget_basin_AIP %>%
  filter(data_source == "mod_truth_cc") %>%
  write_csv(paste(path_version_data,
                  "dcant_budget_basin_AIP_mod_truth_cc.csv", sep = ""))

dcant_budget_basin_MLR %>%
  filter(data_source == "mod_truth") %>%
  write_csv(paste(path_version_data,
                  "dcant_budget_basin_MLR_mod_truth.csv", sep = ""))

dcant_budget_basin_MLR %>%
  filter(data_source == "mod_truth_cc") %>%
  write_csv(paste(path_version_data,
                  "dcant_budget_basin_MLR_mod_truth_cc.csv", sep = ""))

dcant_budget_lat_grid %>%
  filter(data_source == "mod_truth") %>%
  write_csv(paste(path_version_data,
                  "dcant_budget_lat_grid_mod_truth.csv", sep = ""))

dcant_budget_lat_grid %>%
  filter(data_source == "mod_truth_cc") %>%
  write_csv(paste(path_version_data,
                  "dcant_budget_lat_grid_mod_truth_cc.csv", sep = ""))

```


