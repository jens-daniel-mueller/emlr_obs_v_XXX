---
title: "Analysis of dcant budgets"
author: "Jens Daniel MÃ¼ller"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  workflowr::wflow_html:
    number_sections: true
    toc_depth: 3
    toc_float:
      collapsed: false
editor_options:
  chunk_output_type: console
params:
  Version_ID: "v_XXX"
---

```{r parent, child = "/nfs/kryo/work/jenmueller/emlr_cant/utilities/setup_obs.Rmd"}
# this chunk runs the code stored in setup.Rmd
# if required, please refer to instructions given here:
# https://jdblischak.github.io/workflowr/articles/wflow-07-common-code.html
```

```{r read_params_local, include = FALSE}

if (params$Version_ID == "v_XXX") {
  params_local <-
    read_rds(here::here("data/auxillary", "params_local.rds"))
  
} else {
  params_local <-
    read_rds(
      file = paste(path_root, "observations",
                   params$Version_ID,
                   "data/params_local.rds",
                   sep = "/")
    )
  }

```

```{r define_paths, include = FALSE}

# only path_observations needs to be changed to model
path_observations <-
  paste(path_root, "/observations/", sep = "")

path_preprocessing    <-
  paste(path_observations, "preprocessing/", sep = "")

path_version_data     <-
  paste(path_observations,
        params_local$Version_ID,
        "/data/",
        sep = "")

path_version_figures  <-
  paste(path_observations,
        params_local$Version_ID,
        "/figures/",
        sep = "")
```

```{r load_libraries_specific, include = FALSE}
library(scales)
library(marelac)
library(kableExtra)
library(gt)
```

# Version ID

The results displayed on this site correspond to the Version_ID: `r params$Version_ID`

# Data sources

dcant estimates from this sensitivity case:

- Mean and SD per grid cell (lat, lon, depth)
- Zonal mean and SD (basin, lat, depth)
- Inventories (lat, lon)


```{r read_dcant_budget_files}

# integrated per basin_AIP

dcant_budget_basin_AIP <-
  read_csv(paste(path_version_data,
                 "dcant_budget_basin_AIP.csv",
                 sep = "")) %>% 
  filter(method == "total") %>% 
  select(-method)

dcant_budget_basin_AIP_mod_truth <-
  read_csv(paste(
    path_version_data,
    "dcant_budget_basin_AIP_mod_truth.csv",
    sep = ""
  )) %>% 
  filter(method == "total") %>% 
  select(-method)

dcant_budget_basin_AIP <- bind_rows(dcant_budget_basin_AIP,
                                    dcant_budget_basin_AIP_mod_truth)

rm(dcant_budget_basin_AIP_mod_truth)

# globally integrated

dcant_budget_global <-
  read_csv(paste(path_version_data,
                 "dcant_budget_global.csv",
                 sep = "")) %>% 
  filter(method == "total") %>% 
  select(-method)

dcant_budget_global_mod_truth <-
  read_csv(paste(
    path_version_data,
    "dcant_budget_global_mod_truth.csv",
    sep = ""
  )) %>% 
  filter(method == "total") %>% 
  select(-method)

dcant_budget_global <- bind_rows(dcant_budget_global,
                                    dcant_budget_global_mod_truth)

rm(dcant_budget_global_mod_truth)

# reference year

tref <-
  read_csv(paste(path_version_data,
                 "tref.csv",
                 sep = ""))

```

# Time periods

```{r time_periods}

tref

duration <- sort(tref$median_year)[2] - sort(tref$median_year)[1]
duration

```

# Global

## Standard depth

Results integrated over the upper `r params_global$inventory_depth_standard` m

```{r dcant_budget_standard_depth_global}


dcant_budget_global %>%
  filter(inv_depth == params_global$inventory_depth_standard) %>%
  ggplot(aes(estimate, value, fill = data_source)) +
  scale_fill_brewer(palette = "Dark2") +
  geom_col(position = position_dodge2())

dcant_budget_global %>%
  filter(inv_depth == params_global$inventory_depth_standard) %>%
  select(-inv_depth) %>% 
  pivot_wider(names_from = estimate,
              values_from = value) %>% 
  gt(
    groupname_col = c("data_source")
  ) %>%
  summary_rows(groups = TRUE,
               fns = list(total = "sum"))


dcant_budget_global_bias <- dcant_budget_global %>%
  filter(data_source %in% c("mod", "mod_truth")) %>%
  select(data_source, inv_depth, estimate, value) %>%
  pivot_wider(names_from = data_source,
              values_from = value) %>%
  mutate(dcant_bias = mod - mod_truth,
         dcant_bias_rel = dcant_bias / mod_truth * 100)

dcant_budget_global_bias %>% 
  filter(inv_depth == params_global$inventory_depth_standard) %>% 
  ggplot(aes(dcant_bias, estimate)) +
  geom_vline(xintercept = 0) +
  geom_col() +
  scale_fill_brewer(palette = "Dark2")

dcant_budget_global_bias %>% 
  filter(inv_depth == params_global$inventory_depth_standard) %>% 
  ggplot(aes(dcant_bias_rel, estimate)) +
  geom_vline(xintercept = 0) +
  geom_col() +
  scale_fill_brewer(palette = "Dark2")

dcant_budget_global_bias %>%
  filter(inv_depth == params_global$inventory_depth_standard) %>%
  ggplot() +
  geom_col(aes(estimate, mod,
               fill = "eMLR")) +
  geom_col(aes(estimate, mod_truth,
               col = "truth"),
           fill = "transparent") +
  scale_fill_manual(values = "grey60") +
  scale_color_manual(values = c("red", "red")) +
  theme(legend.title = element_blank()) +
  labs(y = "value")
  # geom_segment(aes(
  #   x = estimate,
  #   y = mod,
  #   xend = estimate,
  #   yend = mod_truth,
  #   col = "truth"
  # )) +
  # geom_point(aes(x = estimate,
  #                y = mod_truth,
  #                col = "truth"))


```

## Other depths

Results integrated over the upper `r params_global$inventory_depths` m

```{r cant_budget_other_depth_global, fig.asp=1}

dcant_budget_global <- dcant_budget_global %>%
  mutate(inv_depth = as.factor(inv_depth))

dcant_budget_global %>%
  ggplot() +
  scale_fill_viridis_d() +
  geom_col(aes(data_source, value, fill = inv_depth),
           position = position_dodge2()) +
  facet_grid(. ~ estimate, scales = "free_y")

dcant_budget_global %>%
  pivot_wider(names_from = estimate,
              values_from = value) %>% 
  gt(
    groupname_col = c("data_source", "inv_depth"),
    row_group.sep = " | Depth: "
  ) %>%
  summary_rows(groups = TRUE,
               fns = list(total = "sum"))


dcant_budget_global_bias %>% 
  ggplot(aes(dcant_bias, estimate)) +
  geom_vline(xintercept = 0) +
  geom_col() +
  scale_fill_brewer(palette = "Dark2") +
  facet_grid(inv_depth ~ .)

dcant_budget_global_bias %>% 
  ggplot(aes(dcant_bias_rel, estimate)) +
  geom_vline(xintercept = 0) +
  geom_col(position = "dodge") +
  scale_fill_brewer(palette = "Dark2") +
  facet_grid(inv_depth ~ .)

dcant_budget_global_bias %>%
  ggplot() +
  geom_vline(xintercept = 0) +
  geom_col(aes(mod, estimate, fill = "eMLR"),
           position = "dodge") +
  geom_col(aes(mod_truth, estimate,
               col = "truth"),
           fill = "transparent") +
  scale_fill_manual(values = "grey60") +
  scale_color_manual(values = c("red", "red")) +
  theme(legend.title = element_blank()) +
  labs(x = "value") +
  facet_grid(inv_depth ~ .)

```

# Basin AIP

## Standard depth

Results integrated over the upper `r params_global$inventory_depth_standard` m

```{r dcant_budget_standard_depth_basin_AIP}

dcant_budget_basin_AIP %>%
  filter(inv_depth == params_global$inventory_depth_standard) %>%
  ggplot(aes(estimate, value, fill=basin_AIP)) +
  scale_fill_brewer(palette = "Dark2") +
  geom_col() +
  facet_grid(~data_source)

dcant_budget_basin_AIP %>%
  filter(inv_depth == params_global$inventory_depth_standard) %>%
  pivot_wider(names_from = estimate,
              values_from = value) %>% 
  gt(
    rowname_col = "basin_AIP",
    groupname_col = c("data_source", "inv_depth"),
    row_group.sep = " | Depth: "
  ) %>%
  summary_rows(groups = TRUE,
               fns = list(total = "sum"))


dcant_budget_basin_AIP_bias <- dcant_budget_basin_AIP %>%
  filter(data_source %in% c("mod", "mod_truth")) %>%
  select(data_source, basin_AIP, inv_depth, estimate, value) %>%
  pivot_wider(names_from = data_source,
              values_from = value) %>%
  mutate(dcant_bias = mod - mod_truth,
         dcant_bias_rel = dcant_bias / mod_truth * 100)

dcant_budget_basin_AIP_bias %>% 
  filter(inv_depth == params_global$inventory_depth_standard) %>% 
  ggplot(aes(dcant_bias, estimate, fill=basin_AIP)) +
  geom_vline(xintercept = 0) +
  geom_col() +
  scale_fill_brewer(palette = "Dark2")

dcant_budget_basin_AIP_bias %>% 
  filter(inv_depth == params_global$inventory_depth_standard) %>% 
  ggplot(aes(dcant_bias_rel, estimate, fill=basin_AIP)) +
  geom_vline(xintercept = 0) +
  geom_col(position = "dodge") +
  scale_fill_brewer(palette = "Dark2")


```

## Other depths

Results integrated over the upper `r params_global$inventory_depths` m

```{r cant_budget_other_depth_basin_AIP, fig.asp=1}

dcant_budget_basin_AIP %>%
  ggplot(aes(data_source, value, fill=basin_AIP)) +
  scale_fill_brewer(palette = "Dark2") +
  geom_col() +
  facet_grid(inv_depth ~ estimate, scales = "free_y")

dcant_budget_basin_AIP %>%
  pivot_wider(names_from = estimate,
              values_from = value) %>% 
  gt(
    rowname_col = "basin_AIP",
    groupname_col = c("data_source", "inv_depth"),
    row_group.sep = " | Depth: "
  ) %>%
  summary_rows(groups = TRUE,
               fns = list(total = "sum"))


dcant_budget_basin_AIP_bias %>% 
  ggplot(aes(dcant_bias, estimate, fill=basin_AIP)) +
  geom_vline(xintercept = 0) +
  geom_col() +
  scale_fill_brewer(palette = "Dark2") +
  facet_grid(inv_depth ~ .)

dcant_budget_basin_AIP_bias %>% 
  ggplot(aes(dcant_bias_rel, estimate, fill=basin_AIP)) +
  geom_vline(xintercept = 0) +
  geom_col(position = "dodge") +
  scale_fill_brewer(palette = "Dark2") +
  facet_grid(inv_depth ~ .)


```


# Write files

```{r write_cant_files}

dcant_budget_basin_AIP_bias %>%
  write_csv(paste(path_version_data,
                  "dcant_budget_basin_AIP_bias.csv", sep = ""))

dcant_budget_global_bias %>%
  write_csv(paste(path_version_data,
                  "dcant_budget_global_bias.csv", sep = ""))

```



