---
title: "Analysis of cant estimates"
author: "Jens Daniel MÃ¼ller"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  workflowr::wflow_html:
    number_sections: true
    toc_depth: 3
    toc_float:
      collapsed: false
editor_options:
  chunk_output_type: console
---

```{r parent, child = "/nfs/kryo/work/jenmueller/emlr_cant/utilities/setup.Rmd"}
# this chunk runs the code stored in setup.Rmd
# if required, please refer to instructions given here:
# https://jdblischak.github.io/workflowr/articles/wflow-07-common-code.html
```

```{r read_params_local, include = FALSE}
params_local <-
  read_rds(here::here("data/auxillary",
                       "params_local.rds"))

```

```{r define_paths, include = FALSE}

# only path_observations needs to be changed to model
path_observations <-
  paste(path_root, "/observations/", sep = "")

path_preprocessing    <-
  paste(path_observations, "preprocessing/", sep = "")

path_version_data     <-
  paste(path_observations,
        params_local$Version_ID,
        "/data/",
        sep = "")

path_version_figures  <-
  paste(path_observations,
        params_local$Version_ID,
        "/figures/",
        sep = "")
```

```{r load_libraries_specific, include = FALSE}
library(scales)
library(marelac)
library(kableExtra)
library(gt)
```

# Data sources

Cant estimates from this sensitivity case:

- Mean and SD per grid cell (lat, lon, depth)
- Zonal mean and SD (basin, lat, depth)
- Inventories (lat, lon)


```{r read_cant_files}

cant_inv <-
  read_csv(paste(path_version_data,
                 "cant_inv.csv",
                 sep = ""))

cant_inv_mod_truth <-
  read_csv(paste(path_version_data,
                 "cant_inv_mod_truth.csv",
                 sep = ""))

cant_inv <- bind_rows(cant_inv, cant_inv_mod_truth)

tref <-
  read_csv(paste(path_version_data,
                 "tref.csv",
                 sep = ""))

```

# Time periods

```{r time_periods}

tref

duration <- sort(tref$median_year)[2] - sort(tref$median_year)[1]
duration

```


# Cant budgets

Global Cant inventories were estimated in units of Pg C. Please note that here we added Cant (all vs postitive only) values and do not apply additional corrections for areas not covered.

```{r calculate_global_inventory}

cant_inv_budget <- cant_inv %>% 
  mutate(surface_area = earth_surf(lat, lon),
         cant_inv_grid = cant_inv*surface_area,
         cant_pos_inv_grid = cant_pos_inv*surface_area) %>% 
  group_by(basin_AIP, data_source, inv_depth) %>% 
  summarise(cant_total = sum(cant_inv_grid)*12*1e-15,
            cant_total = round(cant_total,1),
            cant_pos_total = sum(cant_pos_inv_grid)*12*1e-15,
            cant_pos_total = round(cant_pos_total,1)) %>% 
  ungroup()

cant_inv_budget %>%  
  group_by(data_source, inv_depth) %>% 
  summarise(cant_total = sum(cant_total),
            cant_total = round(cant_total,1),
            cant_pos_total = sum(cant_pos_total),
            cant_pos_total = round(cant_pos_total,1),
            cant_total_rate = cant_total / duration,
            cant_pos_total_rate = cant_pos_total / duration) %>% 
  ungroup()


```

## Standard depth

Results integrated over the upper `r params_global$inventory_depth_standard` m

```{r cant_budget_standard_depth}

cant_inv_budget %>%
  filter(inv_depth == params_global$inventory_depth_standard) %>% 
  pivot_longer(cols = c(cant_total, cant_pos_total), names_to = "estimate", values_to = "cant_total") %>% 
  ggplot(aes(data_source, cant_total, fill = basin_AIP)) +
  scale_fill_brewer(palette = "Dark2") +
  geom_col() +
  facet_wrap(~ estimate)

cant_inv_budget %>%
  filter(inv_depth == params_global$inventory_depth_standard) %>% 
  gt(rowname_col = "basin_AIP",
     groupname_col = c("data_source", "inv_depth"),
     row_group.sep = " | Depth: ") %>% 
  summary_rows(
    groups = TRUE,
    fns = list(total = "sum")
  )


cant_inv_bias <- cant_inv_budget %>%
  filter(data_source %in% c("mod", "mod_truth")) %>%
  select(data_source, basin_AIP, inv_depth, cant_pos_total, cant_total) %>%
  pivot_longer(cols = c(cant_total, cant_pos_total), names_to = "estimate", values_to = "cant_total") %>% 
  pivot_wider(names_from = data_source,
              values_from = cant_total) %>%
  mutate(cant_bias = mod - mod_truth,
         cant_bias_rel = cant_bias / mod_truth)

cant_inv_bias %>% 
  filter(inv_depth == params_global$inventory_depth_standard) %>% 
  ggplot(aes(cant_bias, estimate, fill=basin_AIP)) +
  geom_vline(xintercept = 0) +
  geom_col() +
  scale_fill_brewer(palette = "Dark2")


```

## Other depths

Results integrated over the upper `r params_global$inventory_depths` m

```{r cant_budget_other_depth, fig.asp=1}

cant_inv_budget %>%
  filter(inv_depth != params_global$inventory_depth_standard) %>% 
  pivot_longer(cols = c(cant_total, cant_pos_total), names_to = "estimate", values_to = "cant_total") %>% 
  ggplot(aes(data_source, cant_total, fill = basin_AIP)) +
  scale_fill_brewer(palette = "Dark2") +
  geom_col() +
  facet_grid(inv_depth ~ estimate, scales = "free_y")

cant_inv_budget %>%
  filter(inv_depth != params_global$inventory_depth_standard) %>% 
  gt(rowname_col = "basin_AIP",
     groupname_col = c("data_source", "inv_depth"),
     row_group.sep = " | Depth: ") %>% 
  summary_rows(
    groups = TRUE,
    fns = list(total = "sum")
  )

rm(cant_inv_budget)

cant_inv_bias %>% 
  filter(inv_depth != params_global$inventory_depth_standard) %>% 
  ggplot(aes(cant_bias, estimate, fill=basin_AIP)) +
  geom_vline(xintercept = 0) +
  geom_col() +
  scale_fill_brewer(palette = "Dark2") +
  facet_wrap(~ inv_depth)

```
