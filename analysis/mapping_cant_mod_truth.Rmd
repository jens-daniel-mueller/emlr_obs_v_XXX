---
title: "Mapping cant"
author: "Jens Daniel MÃ¼ller"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  workflowr::wflow_html:
    number_sections: true
    toc_depth: 3
    toc_float:
      collapsed: false
editor_options:
  chunk_output_type: console
---

```{r parent, child = "/nfs/kryo/work/jenmueller/emlr_cant/utilities/setup.Rmd"}
# this chunk runs the code stored in setup.Rmd
# if required, please refer to instructions given here:
# https://jdblischak.github.io/workflowr/articles/wflow-07-common-code.html
```

```{r read_params_local, include = FALSE}
params_local <-
  read_rds(here::here("data/auxillary",
                       "params_local.rds"))

```

```{r define_paths, include = FALSE}

# only path_observations needs to be changed to model
path_observations <-
  paste(path_root, "/observations/", sep = "")

path_preprocessing    <-
  paste(path_observations, "preprocessing/", sep = "")

path_model_preprocessing    <-
  paste(path_root, "/model/preprocessing/", sep = "")

path_version_data     <-
  paste(path_observations,
        params_local$Version_ID,
        "/data/",
        sep = "")

path_version_figures  <-
  paste(path_observations,
        params_local$Version_ID,
        "/figures/",
        sep = "")
```

```{r load_libraries_specific, include=FALSE}


```

# Required data

## Predictor fields


```{r read_model_cant_files}

tref  <-
  read_csv(paste(path_version_data,
                 "tref.csv",
                 sep = ""))

cant_tref_1 <-
  read_csv(
    paste(
      path_model_preprocessing,
      "cant_annual_field_AD",
      "/cant_",
      unique(tref$year[1]),
      ".csv",
      sep = ""
    )
  )

cant_tref_1 <- cant_tref_1 %>%
  rename(cant_tref_1 = cant_total) %>%
  select(-year)

cant_tref_2 <-
  read_csv(
    paste(
      path_model_preprocessing,
      "cant_annual_field_AD",
      "/cant_",
      unique(tref$year[2]),
      ".csv",
      sep = ""
    )
  )

cant_tref_2 <- cant_tref_2 %>%
  rename(cant_tref_2 = cant_total) %>%
  select(-year)

```


```{r select_basin_mask, include=FALSE}

basinmask <- basinmask %>% 
  filter(MLR_basins == params_local$MLR_basins) %>% 
  select(-c(MLR_basins, basin_AIP))

```


```{r load_model_gamma_climatology}

climatology <-
  read_csv(paste(path_model_preprocessing, "climatology_runA_2007.csv", sep = ""))

climatology <- climatology %>%
  select(lon,lat,depth, gamma)

```


```{r calc_model_cant_between_tref}

cant_average <- left_join(cant_tref_1, cant_tref_2) %>%
  mutate(cant = cant_tref_2 - cant_tref_1) %>%
  select(-c(cant_tref_1, cant_tref_2))

cant_average <- cant_average %>%
  mutate(cant_pos = if_else(cant <= 0, 0, cant))

rm(cant_tref_1, cant_tref_2)

cant_average <- full_join(cant_average, climatology)
rm(climatology)

cant_average <- inner_join(basinmask, cant_average)

cant_average <-
  m_cant_model_average(cant_average %>% mutate(eras = "blank"))

cant_average <- m_cut_gamma(cant_average, "gamma")

cant_average <- cant_average %>% 
  mutate(data_source = "mod_truth") %>% 
  select(lon, lat, depth, eras, basin, basin_AIP, data_source,
            cant, cant_pos, cant_sd, cant_pos_sd,
            gamma, gamma_sd, gamma_slab)

```



## Average model Cant


```{r cant_deep_climatology_map, fig.asp=0.6}

p_map_climatology(df = cant_average,
                  var = "cant_pos")

```


```{r cant_deep_climatology_sections, fig.asp=1}

p_section_climatology_regular(df = cant_average,
                              var = "cant_pos")

```


## Zonal mean sections

```{r calc_cant_zonal_mean_sections}

cant_average_zonal <- m_cant_zonal_mean_data_source(cant_average)
cant_average_zonal <- m_cut_gamma(cant_average_zonal, "gamma_mean")

```

## Inventory calculation

To calculate Cant column inventories, we:  

1. Convert Cant concentrations to volumetric units
2. Multiply layer thickness with volumetric Cant concentration to get a layer inventory
3. For each horizontal grid cell and era, sum cant layer inventories for different inventory depths (`r params_global$inventory_depths` m)

Step 2 is performed separately for all Cant and positive Cant values only.

```{r cant_inventories, fig.asp=1}

cant_inv <- m_cant_inv_data_source(cant_average)

p_map_cant_inv(df = cant_inv,
               var = "cant_pos_inv",
               subtitle_text = "for predefined integration depths") +
  facet_grid(inv_depth ~ data_source)

```

# Write csv

```{r write_cant_files}


cant_average %>%
  write_csv(paste(path_version_data,
                  "cant_3d_mod_truth.csv", sep = ""))

cant_average_zonal %>%
  write_csv(paste(path_version_data,
                  "cant_zonal_mod_truth.csv", sep = ""))

cant_inv %>%
  write_csv(paste(path_version_data,
                  "cant_inv_mod_truth.csv", sep = ""))

```


