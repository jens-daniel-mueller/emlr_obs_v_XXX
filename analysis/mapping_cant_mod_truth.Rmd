---
title: "Mapping cant"
author: "Jens Daniel MÃ¼ller"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  workflowr::wflow_html:
    number_sections: true
    toc_depth: 3
    toc_float:
      collapsed: false
editor_options:
  chunk_output_type: console
params:
  Version_ID: "v_XXX"
---

```{r parent, child = "/nfs/kryo/work/jenmueller/emlr_cant/utilities/setup.Rmd"}
# this chunk runs the code stored in setup.Rmd
# if required, please refer to instructions given here:
# https://jdblischak.github.io/workflowr/articles/wflow-07-common-code.html
```

```{r read_params_local, include = FALSE}

if (params$Version_ID == "v_XXX") {
  params_local <-
    read_rds(here::here("data/auxillary", "params_local.rds"))
  
} else {
  params_local <-
    read_rds(
      file = paste(path_root, "observations",
                   params$Version_ID,
                   "data/params_local.rds",
                   sep = "/")
    )
}


```

```{r define_paths, include = FALSE}

# only path_observations needs to be changed to model
path_observations <-
  paste(path_root, "/observations/", sep = "")

path_preprocessing    <-
  paste(path_observations, "preprocessing/", sep = "")

path_model_preprocessing    <-
  paste(path_root, "/model/preprocessing/", sep = "")

path_version_data     <-
  paste(path_observations,
        params_local$Version_ID,
        "/data/",
        sep = "")

path_version_figures  <-
  paste(path_observations,
        params_local$Version_ID,
        "/figures/",
        sep = "")
```

```{r load_libraries_specific, include=FALSE}


```

# Version ID

The results displayed on this site correspond to the Version_ID: `r params$Version_ID`

# Required data

## Predictor fields


```{r read_model_cant_files}

tref  <-
  read_csv(paste(path_version_data,
                 "tref.csv",
                 sep = ""))

cant_tref_1 <-
  read_csv(
    paste(
      path_model_preprocessing,
      "cant_annual_field_AD",
      "/cant_",
      unique(tref$median_year[1]),
      ".csv",
      sep = ""
    )
  )

cant_tref_1 <- cant_tref_1 %>%
  rename(cant_tref_1 = cant_total) %>%
  select(-year)

cant_tref_2 <-
  read_csv(
    paste(
      path_model_preprocessing,
      "cant_annual_field_AD",
      "/cant_",
      unique(tref$median_year[2]),
      ".csv",
      sep = ""
    )
  )

cant_tref_2 <- cant_tref_2 %>%
  rename(cant_tref_2 = cant_total) %>%
  select(-year)

```



```{r read_model_cant_files_cc}

cant_cc_tref_1 <-
  read_csv(
    paste(
      path_model_preprocessing,
      "cant_annual_field_CB",
      "/cant_",
      unique(tref$median_year[1]),
      ".csv",
      sep = ""
    )
  )

cant_cc_tref_1 <- cant_cc_tref_1 %>%
  rename(cant_tref_1 = cant_total) %>%
  select(-year)

cant_cc_tref_2 <-
  read_csv(
    paste(
      path_model_preprocessing,
      "cant_annual_field_CB",
      "/cant_",
      unique(tref$median_year[2]),
      ".csv",
      sep = ""
    )
  )

cant_cc_tref_2 <- cant_cc_tref_2 %>%
  rename(cant_tref_2 = cant_total) %>%
  select(-year)

```


```{r select_basin_mask, include=FALSE}

basinmask <- basinmask %>% 
  filter(MLR_basins == params_local$MLR_basins) %>% 
  select(-c(MLR_basins, basin_AIP))

```


```{r load_model_gamma_climatology}

climatology <-
  read_csv(paste(path_model_preprocessing, "climatology_runA_2007.csv", sep = ""))

climatology <- climatology %>%
  select(lon,lat,depth, gamma)

```


```{r calc_model_cant_between_tref}

cant_average <- left_join(cant_tref_1, cant_tref_2) %>%
  mutate(cant = cant_tref_2 - cant_tref_1)

rm(cant_tref_1, cant_tref_2)

cant_average <- cant_average %>%
  mutate(cant_pos = if_else(cant <= 0, 0, cant))

cant_average <- inner_join(basinmask, cant_average)

cant_average <- full_join(cant_average, climatology)

cant_average <-
  m_cant_model_average(cant_average %>% mutate(eras = "blank"))

cant_average <- m_cut_gamma(cant_average, "gamma")

cant_average_vc <- cant_average %>% 
  mutate(data_source = "mod_truth") %>% 
  select(lon, lat, depth, eras, basin, basin_AIP, data_source,
            cant_tref_1, cant, cant_pos, cant_sd, cant_pos_sd,
            gamma, gamma_sd, gamma_slab)

```

```{r calc_model_cant_between_tref_cc}

cant_average <- left_join(cant_cc_tref_1, cant_cc_tref_2) %>%
  mutate(cant = cant_tref_2 - cant_tref_1)

rm(cant_cc_tref_1, cant_cc_tref_2)

cant_average <- cant_average %>%
  mutate(cant_pos = if_else(cant <= 0, 0, cant))

cant_average <- inner_join(basinmask, cant_average)

cant_average <- full_join(cant_average, climatology)

cant_average <-
  m_cant_model_average(cant_average %>% mutate(eras = "blank"))

cant_average <- m_cut_gamma(cant_average, "gamma")

cant_average_cc <- cant_average %>% 
  mutate(data_source = "mod_truth_cc") %>% 
  select(lon, lat, depth, eras, basin, basin_AIP, data_source,
            cant_tref_1, cant, cant_pos, cant_sd, cant_pos_sd,
            gamma, gamma_sd, gamma_slab)

rm(climatology, cant_average)

```

```{r join_climate_runs}

cant_average <- bind_rows(
  cant_average_cc,
  cant_average_vc
)

rm(
  cant_average_cc,
  cant_average_vc
)


```


## Average model Cant


```{r cant_deep_climatology_map, fig.asp=0.6}

cant_average %>%
  group_split(data_source) %>%
  # head(1) %>%
  map(~ p_map_climatology(
    df = .x,
    var = "cant_pos",
    subtitle_text = paste("Climate: ", .x$data_source)
  ))

```


```{r cant_deep_climatology_sections, fig.asp=1}


cant_average %>%
  group_split(data_source) %>%
  # head(1) %>%
  map(~ p_section_climatology_regular(
    df = .x,
    var = "cant_pos",
    subtitle_text = paste("Climate: ", .x$data_source)
  ))

```


## Zonal mean sections

```{r calc_cant_zonal_mean_sections}

cant_average_zonal <- m_cant_zonal_mean_data_source(cant_average)
cant_average_zonal <- m_cut_gamma(cant_average_zonal, "gamma_mean")

```

## Inventory calculation

To calculate Cant column inventories, we:  

1. Convert Cant concentrations to volumetric units
2. Multiply layer thickness with volumetric Cant concentration to get a layer inventory
3. For each horizontal grid cell and era, sum cant layer inventories for different inventory depths (`r params_global$inventory_depths` m)

Step 2 is performed separately for all Cant and positive Cant values only.

```{r cant_inventories, fig.asp=1}

cant_inv <- m_cant_inv_data_source(cant_average)

p_map_cant_inv(df = cant_inv,
               var = "cant_pos_inv",
               subtitle_text = "for predefined integration depths") +
  facet_grid(inv_depth ~ data_source)

```

```{r cant_total_inventories, fig.asp=1}

cant_total_inv <- m_cant_inv_data_source(
  cant_average %>%
    select(-c(cant, cant_pos)) %>%
    rename(cant = cant_tref_1) %>%
    mutate(cant_pos = if_else(cant <= 0, 0, cant))
)

p_map_cant_inv(df = cant_total_inv,
               var = "cant_pos_inv",
               subtitle_text = "for predefined integration depths",
               breaks = seq(0,50,5)) +
  facet_grid(inv_depth ~ data_source)

```

# Alpha

## 3d fields

```{r alpha_3d}

alpha_3d <- cant_average %>% 
  mutate(alpha = cant / cant_tref_1,
         alpha = if_else(cant <= 0 | cant_tref_1 <= 0,
                         NaN, alpha))

alpha_3d %>%
  filter(alpha < 1) %>%
  ggplot(aes(alpha)) +
  geom_histogram() +
  facet_grid(basin_AIP ~ data_source) +
  scale_x_continuous(breaks = seq(0, 1, 0.1))

median_alpha <- 
  alpha_3d %>% 
  group_by(depth, basin_AIP, data_source) %>% 
  summarise(alpha_median = median(alpha, na.rm = TRUE),
            alpha_mean = weighted.mean(alpha, cant_tref_1, na.rm = TRUE)) %>% 
  ungroup()

alpha_3d %>%
  filter(alpha < 1) %>%
  ggplot(aes(alpha, depth)) +
  geom_bin2d(binwidth = c(0.01, 200)) +
  geom_path(data = median_alpha,
            aes(alpha_median, depth, col="Median")) +
  geom_path(data = median_alpha,
            aes(alpha_mean, depth, col="Weighted mean")) +
  scale_color_manual(name = "Alpha",
                     values = c("red", "orange")) +
  scale_y_reverse() +
  scale_x_continuous(breaks = seq(0, 1, 0.1)) +
  scale_fill_viridis_c(trans = "log10") +
  coord_cartesian(expand = 0) +
  facet_grid(basin_AIP~data_source)


print(paste("mean:",
            round(mean(
              alpha_3d$alpha, na.rm = TRUE
            ), 3)))

print(paste("mean, weighted with Cant:",
            round(
              weighted.mean(
                x = alpha_3d$alpha,
                w = alpha_3d$cant_tref_1,
                na.rm = TRUE
              ),
              3
            )))

print(paste("median:",
            round(median(
              alpha_3d$alpha, na.rm = TRUE
            ), 3)))


```

## Inventory maps

```{r alpha_surface_distribution, fig.asp=1.5}

alpha_inv <- bind_rows(
  cant_inv %>% mutate(estimate = "delta_cant"),
  cant_total_inv %>% mutate(estimate = "total_cant")
)

alpha_inv <- alpha_inv %>%
  select(lon, lat, cant_inv, inv_depth, estimate, data_source) %>%
  pivot_wider(names_from = estimate,
              values_from = cant_inv)

alpha_inv <- alpha_inv %>% 
  mutate(alpha = delta_cant / total_cant)


map +
  geom_raster(data = alpha_inv #%>% filter(inv_depth == params_global$inventory_depth_standard)
              ,
              aes(lon, lat, fill = alpha)) +
  facet_grid(inv_depth ~ data_source) +
  scale_fill_divergent(
    midpoint = median(alpha_inv$alpha)
  )


```



# Write csv

```{r write_cant_files}


cant_average <- cant_average %>%
  select(-c(cant_tref_1))

cant_average %>%
  filter(data_source == "model_truth") %>%
  write_csv(paste(path_version_data,
                  "cant_3d_mod_truth.csv", sep = ""))

cant_average %>%
  filter(data_source == "model_truth_cc") %>%
  write_csv(paste(path_version_data,
                  "cant_3d_mod_truth_cc.csv", sep = ""))

cant_average_zonal %>%
  filter(data_source == "model_truth_cc") %>%
  write_csv(paste(path_version_data,
                  "cant_zonal_mod_truth_cc.csv", sep = ""))

cant_average_zonal %>%
  filter(data_source == "model_truth") %>%
  write_csv(paste(path_version_data,
                  "cant_zonal_mod_truth.csv", sep = ""))

cant_inv %>%
  filter(data_source == "model_truth") %>%
  write_csv(paste(path_version_data,
                  "cant_inv_mod_truth.csv", sep = ""))

cant_inv %>%
  filter(data_source == "model_truth_cc") %>%
  write_csv(paste(path_version_data,
                  "cant_inv_mod_truth_cc.csv", sep = ""))

```


